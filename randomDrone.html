<!DOCTYPE html>
<html>
<head>
  <title>Random drone</title>
  <meta charset="utf-8">

  <script src="js/jquery.min.js"></script>
  <script src="js/d3.v3.min.js"></script>
  <script src="js/underscore-min.js"></script>
  <script src="js/mustache.js"></script>
  <script>var mustache = Mustache</script>
  <script src="js/jquery.knob.js"></script>
  <script src="http://funktion.fm/webpd/dist/webpd-latest.js"></script>
  <!--<script src="https://raw.github.com/sebpiq/pd-fileutils/master/dist/pd-fileutils-latest.js"></script>-->
  <script src="../pdfu/dist/pd-fileutils-latest.js"></script>
  <link href="css/reset.css" rel="stylesheet" />
  <link href='http://fonts.googleapis.com/css?family=Paytone+One' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Tauri' rel='stylesheet' type='text/css'>
  <link rel="stylesheet/less" type="text/css" href="css/randomDrone.less" />
  <script src="js/less-1.3.3.min.js" type="text/javascript"></script>


</head>

<body>

  <div id="svg"></div>

  <div id="nav">
    <ul>
      <li>Download patch</li>
      <li>Configure</li>
      <li>About</li>
    </ul>

    <div id="controls">
      <button id="getRandomPatch"><span>Gimme another</span></button>
      <button id="startSound"><span>Play</span></button>
      <button id="stopSound"><span>Stop</span></button>
    </div>
  </div>

  <div id="tabs">

    <div id="pd" class="tab">
      <button id="copyPd">Copy to clipboard</button>
      <textarea></textarea>
      <pre><code></code></pre>
    </div>

    <div id="configuration" class="tab">
      <input id="genOscAmount" type="text" value="50" class="dial genParam">
      <input id="genPhasorAmount" type="text" value="20" class="dial genParam">
      <input id="genNoiseAmount" type="text" value="10" class="dial genParam">
      <input id="genMultAmount" type="text" value="60" class="dial genParam">
      <input id="genAddAmount" type="text" value="50" class="dial genParam">

      <input id="ampModAmount" type="text" value="" class="dial modParam">
      <input id="fmModAmount" type="text" value="" class="dial modParam">
    </div>

    <div id="about" class="tab">
      <p>This is a random drone generator. You can generate a random drone sound, then download the Pure Data patch by clicking on "Download PD patch".</p>
      <p>This is a demo of the <a href="https://github.com/sebpiq/pd-fileutils">pd-fileutils</a> and the <a href="https://github.com/sebpiq/WebPd">WebPd</a> libraries, made by <a href="mailto:sebpiq@gmail.com">SÃ©bastien Piquemal</a>. <b>pd-fileutils</b> is used to generate the random patch, and <b>WebPd</b> alloes to load the patch and play it in the browser without plugin.
      </p>
    </div>

  </div>

  <script>
    var width = $(document).width(), height = $(document).height()
      , patch, patchSvg, patchPd, webpdPatch
      // Function to generate the args of sound oscillators
      , genOscArgs = function() { return [getRandomInt(1, 10) / 5 * 440] }
      // Function to generate the args of modulators
      , modOscArgs = function() { return [Math.round(Math.random() * 10 * 10) / 10] }
      , emptyArgs = function() { return [] }
      , genList = [ ['osc~', 50, genOscArgs], ['phasor~', 20, genOscArgs], ['noise~', 10, emptyArgs], ['*~', 60, emptyArgs], ['+~', 50, emptyArgs] ]
      , modList = [ ['osc~', 10, modOscArgs], ['*~', 10, emptyArgs]]

    // =============== UI =============== //
    // Plays the current patch using webpd
    var startSound = function() {
      webpdPatch.play()
      $('#stopSound').show()
      $('#startSound').hide()
    }
    $('#startSound').click(startSound)

    // Stops playing the patch
    var stopSound = function() {
      webpdPatch.stop()
      $('#startSound').show()
      $('#stopSound').hide()
    }
    $('#stopSound').click(stopSound)

    // Generator configuration
    $('.dial').knob()
    $('.genParam').each(function(i, el) {
      $(this).trigger('configure', {
        release: function(val) { genList[i][1] = val; console.log(i, val) },
        min: 0, max: 100
      })
    })

    $('#copyPd').click(function() {
      
    })

    // Setup tabs
    $('#nav li').each(function(i, li) {
      $(li).click(function() {
        $('#tabs .tab').removeClass('active')
        $('#tabs .tab').slice(i, i+1).addClass('active')
      })
    })
    $('#tabs .tab').each(function(i, tab) {
      $('<a>', {'class': 'closeTab'}).html('X').appendTo(tab).click(function() {
        $(tab).removeClass('active')
      })
    })

    // =============== Patch generation =============== //
    // Generates a random Pd graph that makes sound
    var randomSoundGen = function() {
      return randomTree(genList, 5, function(node) {
        // Each time a node is created, we pick randomly whether we modulate it or not.
        if (Math.random() > 0.4) {          
          var mod = null
          while(mod === null) mod = randomTree(modList, 3)
          // Freq modulation if `node` is an oscillator
          if (_.contains(['osc~', 'phasor~'], node.proto) && Math.random() > 0.2) {
            var freq = node.args[0]
              , mult = {proto: '*~', args: [Math.round(Math.random() * 100)]}
              , add = {proto: '+~', args: [freq]}
            patch.addNode(mult)
            patch.addNode(add)
            patch.connections.push({source: {id: mod.id, port: 0}, sink: {id: mult.id, port: 0}})
            patch.connections.push({source: {id: mult.id, port: 0}, sink: {id: add.id, port: 0}})
            patch.connections.push({source: {id: add.id, port: 0}, sink: {id: node.id, port: 0}})
            return node
          // Amplitude modulation otherwise
          } else {
            var mult = {proto: '*~', args: []}
            patch.addNode(mult)
            patch.connections.push({source: {id: node.id, port: 0}, sink: {id: mult.id, port: 0}})
            patch.connections.push({source: {id: mod.id, port: 0}, sink: {id: mult.id, port: 1}})
            return mult
          }
        } else return node
      })
    }

    // Generic function for generating a random tree of Pd objects. 
    var randomTree = function(objList, maxDepth, nodeCb, curDepth) {
      curDepth = (curDepth === undefined) ? -1 : curDepth
      curDepth++

      // If max depth is reached, we return null, the parent will take care of picking a leaf
      if (curDepth >= maxDepth) {
        curDepth--
        return null
      }

      var proto, node, randVal, i, cum
        // For picking a leaf, when the tree is too big
        , getLeaf = function(parent) {
          var leaf = {proto: 'sig~'}
          if (_.contains(['+~', '-~'], parent.proto)) leaf.args = [0]
          else leaf.args = [1]
          patch.addNode(leaf)
          return leaf
        }

      // Pick a random proto
      randVal = Math.random() * _.reduce(objList, function(memo, obj) { return memo + obj[1] }, 0)
      i = 0
      cum = 0
      while(true) {
        cum += objList[i][1]
        if (cum >= randVal) break
        i++
      }
      proto = objList[i][0]
      node = {proto: proto, args: objList[i][2]()}

      // If it is a dsp arithmetic, we call the function recursively
      // to get 2 subtrees that we'll connect together.
      if (isArithm(node)) {
        var subtree1 = randomTree(objList, maxDepth, nodeCb, curDepth)
          , subtree2 = randomTree(objList, maxDepth, nodeCb, curDepth)

        // If both subtrees are null, we simply discard the node
        if (subtree1 === null && subtree2 === null) {
          curDepth--
          return null
        } else {
          patch.addNode(node)
          if (subtree1 === null) subtree1 = getLeaf(node)
          if (subtree2 === null) subtree2 = getLeaf(node)
          patch.connections.push({source: {id: subtree1.id, port: 0}, sink: {id: node.id, port: 0}})
          patch.connections.push({source: {id: subtree2.id, port: 0}, sink: {id: node.id, port: 1}})
        }
      } else patch.addNode(node)

      curDepth--
      if (nodeCb) node = nodeCb(node)
      return node
    }

    // Function for generating our random patch, and updating the page
    var getRandomPatch = function() {
      if (webpdPatch) stopSound()
      patch = new pdfu.Patch({nodes: [], connections: []})

      var root = randomSoundGen()
        , dac = {proto: 'dac~', args: []}
        , treeLayout = d3.layout.tree()

      // Connect the root of the tree with [dac~]
      patch.addNode(dac)
      patch.connections.push({source: {id: root.id, port: 0}, sink: {id: dac.id, port: 0}})
      patch.connections.push({source: {id: root.id, port: 0}, sink: {id: dac.id, port: 1}})

      // Create the tree layout
      treeLayout.children(function(node) {
        var sources = patch.getSources(node)
        return sources.length ? sources : null
      })
      treeLayout.nodes(dac)
      _.each(patch.nodes, function(node) {
        node.layout = {}
        node.layout.x = Math.round(node.x * width / 2)
        node.layout.y = Math.round(height / 2 - node.y * height / 3)
        delete node.parent ; delete node.children 
      })

      // Rendering and updating the page
      patchSvg = pdfu.renderSvg(patch, {svgFile: false})
      patchPd = pdfu.renderPd(patch)
      webpdPatch = Pd.compat.parse(patchPd)
      $('#svg').html(patchSvg)
      $('#pd code').html(patchPd)
      $('#pd textarea').val(patchPd)
    }
    $('#getRandomPatch').click(getRandomPatch)

    // Returns a random integer between `min` and `max`
    var getRandomInt = function(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Returns true if the node is a dsp arithmetic operation
    var isArithm = function(node) {
      return _.contains(['+~', '-~', '*~', '/~'], node.proto)
    }
    
    getRandomPatch()
  </script>

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17637518-3']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
</body>

</html>
