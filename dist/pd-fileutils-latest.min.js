/*
 * pd-fileutils - v0.0.2
 * Copyright (c) 2013 SÃ©bastien Piquemal <sebpiq@gmail.com> http://funktion.fm/
 *
 * BSD Simplified License.
 * For information on usage and redistribution, and for a DISCLAIMER OF ALL
 * WARRANTIES, see the file, "LICENSE.txt," in this distribution.
 *
 * See git@github.com:sebpiq/pd-fileutils.git for documentation
 *
 */
(function(){var t=this.pdfu={},r={underscore:this._},e={},n=function(t){return t=t.split("/").slice(-1)[0],e[t]&&e[t].exports||r[t]||window[t]};(function(t,r,e){var n=e("underscore"),i=t.exports=function(t){n.extend(this,t)};i.prototype.getObject=function(t){return n.find(this.nodes,function(r){return r.id===t})||null},i.prototype.guessPortlets=function(){var t=this;n.each(this.nodes,function(r){r.outlets=n.reduce(t.connections,function(t,e){return e.source.id===r.id?Math.max(t,e.source.port):t},-1)+1,r.inlets=n.reduce(t.connections,function(t,e){return e.sink.id===r.id?Math.max(t,e.sink.port):t},-1)+1})}})(e.Patch={},r.Patch={},n),function(t,r,e){var n=e("underscore"),i=/ |\r\n?|\n/,o=/\\(\$\d+)/g,a=/(#((.|\r|\n)*?)[^\\\\])\r{0,1}\n{0,1};\r{0,1}(\n|$)/i,s=r.parseArg=function(t){var r=u(t);if(n.isNumber(r)&&!isNaN(r))return r;if(n.isString(t)){for(var e,t=t.substr(0);e=o.exec(t);)t=t.replace(e[0],e[1]);return t}throw Error("couldn't parse arg "+t)},u=r.parseFloat=function(t){return n.isNumber(t)&&!isNaN(t)?t:n.isString(t)?parseFloat(t):0/0},c=r.parseArgs=function(t){if(n.isNumber(t)&&!isNaN(t))return[t];var r,e,o,a=n.isString(t)?t.split(i):t,u=[];for(e=0,o=a.length;o>e;e++)""!==(r=a[e])&&u.push(s(r));return u},l=["obj","floatatom","symbolatom","msg","text"];r.parse=function(t){return p(t)[0]};var p=function(t){var r,e=null,o=-1,s=function(){return o++,o},u={nodes:[],connections:[]},d=!0;for(a.lastIndex=0;r=t.match(a);){t=t.slice(r.index+r[0].length);var f=r[1].split(i),h=f[0];if("#N"===h){var g=f[1];if("canvas"!==g)throw Error("invalid element type for chunk #N : "+g);var v=f[2],b=f[3];if(f[4],f[5],f[6],!d){var x=p(t),w=x[0],m=x[2];u.nodes.push(n.extend({id:s(),subpatch:w},m)),t=x[1]}}else if("#X"===h){var g=f[1];if("restore"===g){var v=parseInt(f[2],10),b=parseInt(f[3],10),y=f[4],j=[];if("pd"===y&&j.push(f[5]),e){for(var N=e.args[1];N>e.data.length;)e.data.push(0);e=null}return[u,t,{proto:y,args:j,guiData:{x:v,y:b}}]}if(n.contains(l,g)){var k,j,v=parseInt(f[2],10),b=parseInt(f[3],10);"obj"===g?(k=f[4],j=f.slice(5)):(k=g,j=f.slice(4)),"text"===g&&(j=[f.slice(4).join(" ")]),u.nodes.push({id:s(),proto:k,guiData:{x:v,y:b},args:c(j)})}else if("array"===g){var I=f[2],W=parseFloat(f[3]),M={id:s(),proto:"table",args:[I,W],data:[]};u.nodes.push(M),e=M}else if("connect"===g){var O=parseInt(f[2],10),D=parseInt(f[4],10),H=parseInt(f[3],10),A=parseInt(f[5],10);u.connections.push({source:{id:O,port:H},sink:{id:D,port:A}})}else if("coords"!==g)throw Error("invalid element type for chunk #X : "+g)}else{if("#A"!==h)throw Error("invalid chunk : "+h);var P,E,S,X=parseFloat(f[1]);if(e)for(P=2,E=f.length;E>P;P++,X++)S=parseFloat(f[P]),n.isNumber(S)&&!isNaN(S)&&(e.data[X]=S);else console.error("got table data outside of a table.")}d=!1}return[u,""]}}(e.parsing={},r.parsing={},n),function(t,r,e){var n=e("underscore"),i=e("d3"),o=e("./Patch"),a={portletWidth:5,portletHeight:3.5,objMinWidth:25,objMinHeight:15,ratio:1.2};r.render=function(t){i.select("svg").remove();var r,e,f=i.select("body").append("svg");f.attr("xmlns","http://www.w3.org/2000/svg"),f.attr("version","1.1"),t=new o(t),t.guessPortlets(),r=f.selectAll("line.connection").data(t.connections).enter().append("line").attr("class","connection").attr("style","stroke:black;stroke-width:2px;").each(function(){i.select(this).attr("x1",function(r){var e=t.getObject(r.source.id),n=r.source.port,i=getOutletX(e,n,a)+a.portletWidth/2;return isNaN(i),i}).attr("y1",function(r){var e=t.getObject(r.source.id),n=r.source.port;return getOutletY(e,n,a)+a.portletHeight}).attr("x2",function(r){var e=t.getObject(r.sink.id),n=r.sink.port;return getInletX(e,n,a)+a.portletWidth/2}).attr("y2",function(r){var e=t.getObject(r.sink.id),n=r.sink.port;return getInletY(e,n,a)})}),e=f.selectAll("g.objectGroup").data(t.nodes).enter().append("g").attr("transform",function(t){return"translate("+s(t,a)+","+u(t,a)+")"}).attr("class","objectGroup"),e.append("rect").attr("class","object").attr("width",function(t){return d(t,a)}).attr("height",function(t){return p(t,a)}).attr("style","stroke:black;fill:white;"),e.append("text").attr("class","objectType").text(function(t){return c(t,a)}).attr("dy",function(t){return l(t,a)}).attr("dx",a.portletWidth).attr("style","font-size:10px;"),e.selectAll("rect.inlet").data(function(t){return n.times(t.inlets,function(){return t})}).enter().append("rect").classed("inlet",!0).classed("portlet",!0).attr("width",a.portletWidth).attr("height",a.portletHeight).attr("x",function(t,r){return g(t,r,a)}).attr("y",function(t,r){return b(t,r,a)}),e.selectAll("rect.outlet").data(function(t){return n.times(t.outlets,function(){return t})}).enter().append("rect").classed("outlet",!0).classed("portlet",!0).attr("width",a.portletWidth).attr("height",a.portletHeight).attr("x",function(t,r){return h(t,r,a)}).attr("y",function(t,r){return v(t,r,a)});var x=i.select("body")[0][0].innerHTML;return x='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+x};var s=function(t,r){return t.guiData.x*r.ratio},u=function(t,r){return t.guiData.y*r.ratio},c=function(t){return t.proto+" "+t.args.join(" ")},l=function(t,r){return p(t,r)/2+r.portletHeight/2},p=function(t,r){return r.objMinHeight},d=function(t,r){var e=Math.max(t.inlets,t.outlets),n=5*c(t,r).length;return Math.max((e-1)*r.objMinWidth,r.objMinWidth,n)};getOutletX=function(t,r,e){return h(t,r,e)+s(t,e)},getInletX=function(t,r,e){return g(t,r,e)+s(t,e)},getOutletY=function(t,r,e){return v(t,r,e)+u(t,e)},getInletY=function(t,r,e){return b(t,r,e)+u(t,e)};var f=function(t){return function(r,e,n){var i=d(r,n),o=r[t];if(0===e)return 0;if(e===o-1)return i-n.portletWidth;var a=(i-o*n.portletWidth)/(o-1);return e*(n.portletWidth+a)}},h=f("outlets"),g=f("inlets"),v=function(t,r,e){return p(t,e)-e.portletHeight},b=function(){return 0}}(e["svg-rendering"]={},r["svg-rendering"]={},n),function(t){t.parse=n("./lib/parsing").parse,t.renderSvg=n("./lib/svg-rendering").render}(t)})(window);