/*
 * pd-fileutils - v0.0.2
 * Copyright (c) 2013 SÃ©bastien Piquemal <sebpiq@gmail.com> http://funktion.fm/
 *
 * BSD Simplified License.
 * For information on usage and redistribution, and for a DISCLAIMER OF ALL
 * WARRANTIES, see the file, "LICENSE.txt," in this distribution.
 *
 * See git@github.com:sebpiq/pd-fileutils.git for documentation
 *
 */
(function(){var t=this.pdfu={},e={underscore:this._},r={},n=function(t){return t=t.split("/").slice(-1)[0],r[t]&&r[t].exports||e[t]||window[t]};(function(t,e,r){var n=r("underscore"),o=t.exports=function(t){n.extend(this,t)};n.extend(o.prototype,{getNode:function(t){return n.find(this.nodes,function(e){return e.id===t})||null},guessPortlets:function(){var t=this;n.each(this.nodes,function(e){e.outlets=n.reduce(t.connections,function(t,r){return r.source.id===e.id?Math.max(t,r.source.port):t},-1)+1,e.inlets=n.reduce(t.connections,function(t,r){return r.sink.id===e.id?Math.max(t,r.sink.port):t},-1)+1})}})})(r.Patch={},e.Patch={},n),function(t,e,r){var n=r("underscore"),o=/ |\r\n?|\n/,i=/\\(\$\d+)/g,s=/(#((.|\r|\n)*?)[^\\\\])\r{0,1}\n{0,1};\r{0,1}(\n|$)/i,a=e.parseArg=function(t){var e=l(t);if(n.isNumber(e)&&!isNaN(e))return e;if(n.isString(t)){for(var r,t=t.substr(0);r=i.exec(t);)t=t.replace(r[0],r[1]);return t}throw Error("couldn't parse arg "+t)},l=e.parseFloat=function(t){return n.isNumber(t)&&!isNaN(t)?t:n.isString(t)?parseFloat(t):0/0},u=e.parseArgs=function(t){if(n.isNumber(t)&&!isNaN(t))return[t];var e,r,i,s=n.isString(t)?t.split(o):t,l=[];for(r=0,i=s.length;i>r;r++)""!==(e=s[r])&&l.push(a(e));return l},c=["obj","floatatom","symbolatom","msg","text"];e.parse=function(t){return p(t)[0]};var p=function(t){var e,r=null,i=-1,a=function(){return i++,i},l={nodes:[],connections:[]},h=!0;for(s.lastIndex=0;e=t.match(s);){t=t.slice(e.index+e[0].length);var g=e[1].split(o),d=g[0];if("#N"===d){var f=g[1];if("canvas"!==f)throw Error("invalid element type for chunk #N : "+f);var v=g[2],x=g[3];if(g[4],g[5],g[6],!h){var m=p(t),y=m[0],w=m[2];l.nodes.push(n.extend({id:a(),subpatch:y},w)),t=m[1]}}else if("#X"===d){var f=g[1];if("restore"===f){var v=parseInt(g[2],10),x=parseInt(g[3],10),b=g[4],I=[];if("pd"===b&&I.push(g[5]),r){for(var k=r.args[1];k>r.data.length;)r.data.push(0);r=null}return[l,t,{proto:b,args:I,guiData:{x:v,y:x}}]}if(n.contains(c,f)){var W,I,v=parseInt(g[2],10),x=parseInt(g[3],10);"obj"===f?(W=g[4],I=g.slice(5)):(W=f,I=g.slice(4)),"text"===f&&(I=[g.slice(4).join(" ")]),l.nodes.push({id:a(),proto:W,guiData:{x:v,y:x},args:u(I)})}else if("array"===f){var R=g[2],H=parseFloat(g[3]),X={id:a(),proto:"table",args:[R,H],data:[]};l.nodes.push(X),r=X}else if("connect"===f){var N=parseInt(g[2],10),Y=parseInt(g[4],10),P=parseInt(g[3],10),M=parseInt(g[5],10);l.connections.push({source:{id:N,port:P},sink:{id:Y,port:M}})}else if("coords"!==f)throw Error("invalid element type for chunk #X : "+f)}else{if("#A"!==d)throw Error("invalid chunk : "+d);var O,T,j,E=parseFloat(g[1]);if(r)for(O=2,T=g.length;T>O;O++,E++)j=parseFloat(g[O]),n.isNumber(j)&&!isNaN(j)&&(r.data[E]=j);else console.error("got table data outside of a table.")}h=!1}return[l,""]}}(r.parsing={},e.parsing={},n),function(t,e,r){var n=r("underscore"),o=r("d3"),i=r("./Patch"),s={portletWidth:5,portletHeight:3.5,objMinWidth:25,objMinHeight:15,ratio:1.2};e.render=function(t){o.select("svg").remove();var e,r,a=o.select("body").append("svg").attr("style","font-family:monospace");a.attr("xmlns","http://www.w3.org/2000/svg"),a.attr("version","1.1"),t=new i(t),t.guessPortlets(),t.nodes=n.map(t.nodes,function(t){return"msg"===t.proto?new u(t):"text"===t.proto?new h(t):"floatatom"===t.proto||"symbolatom"===t.proto?new c(t):"bng"===t.proto?new p(t):new l(t)}),r=a.selectAll("g.node").data(t.nodes).enter().append("g").attr("transform",function(t){return"translate("+t.getX()+","+t.getY()+")"}).attr("class","node").each(function(t){t.render(o.select(this))}),e=a.selectAll("line.connection").data(t.connections).enter().append("line").attr("class","connection").attr("style","stroke:black;stroke-width:2px;").each(function(e){var r=t.getNode(e.source.id),n=t.getNode(e.sink.id);o.select(this).attr("x1",function(t){return r.getOutletX(t.source.port)+s.portletWidth/2}).attr("y1",function(t){return r.getOutletY(t.source.port)+s.portletHeight}).attr("x2",function(t){return n.getInletX(t.sink.port)+s.portletWidth/2}).attr("y2",function(t){return n.getInletY(t.sink.port)})});var g=o.select("body")[0][0].innerHTML;return g='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+g};var a=function(t){this.node=t,this.id=t.id};n.extend(a.prototype,{getX:function(){return this.node.guiData.x*s.ratio},getY:function(){return this.node.guiData.y*s.ratio},getOutletX:function(t){return this.getOutletRelX(t)+this.getX()},getInletX:function(t){return this.getInletRelX(t)+this.getX()},getOutletY:function(t){return this.getOutletRelY(t)+this.getY()},getInletY:function(t){return this.getInletRelY(t)+this.getY()},render:function(){throw Error("Implement me")},getOutletRelX:function(){throw Error("Implement me")},getInletRelX:function(){throw Error("Implement me")},getOutletRelY:function(){throw Error("Implement me")},getInletRelY:function(){throw Error("Implement me")}});var l=function(){a.prototype.constructor.apply(this,arguments)};n.extend(l.prototype,a.prototype,{render:function(t){this.renderBox(t),this.renderText(t),this.renderOutlets(t),this.renderInlets(t)},renderBox:function(t){t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:white;")},renderText:function(t){t.append("text").attr("class","proto").text(this.getText()).attr("dy",this.getTextY()).attr("dx",s.portletWidth).attr("style","font-size:10px;")},renderInlets:function(t){this._genericRenderPortlets("inlet",t)},renderOutlets:function(t){this._genericRenderPortlets("outlet",t)},_genericRenderPortlets:function(t,e){var r=t.substr(0,1).toUpperCase()+t.substr(1),o=this;e.selectAll("rect."+t).data(n.range(this.node[t+"s"])).enter().append("rect").classed(t,!0).classed("portlet",!0).attr("width",s.portletWidth).attr("height",s.portletHeight).attr("x",function(t){return o["get"+r+"RelX"](t)}).attr("y",function(t){return o["get"+r+"RelY"](t)})},getH:function(){return s.objMinHeight},getW:function(){var t=Math.max(this.node.inlets,this.node.outlets),e=6.5*this.getText().length;return Math.max((t-1)*s.objMinWidth,s.objMinWidth,e)},getText:function(){return this.node.proto+" "+this.node.args.join(" ")},getTextY:function(){return this.getH()/2+s.portletHeight/2},getOutletRelX:function(t){return this._genericPortletRelX("outlets",t)},getInletRelX:function(t){return this._genericPortletRelX("inlets",t)},getOutletRelY:function(){return this.getH()-s.portletHeight},getInletRelY:function(){return 0},_genericPortletRelX:function(t,e){var r=this.getW(),n=this.node[t];if(0===e)return 0;if(e===n-1)return r-s.portletWidth;var o=(r-n*s.portletWidth)/(n-1);return e*(s.portletWidth+o)}});var u=function(){l.prototype.constructor.apply(this,arguments)};n.extend(u.prototype,l.prototype,{renderBox:function(t){var e=.75*this.getH(),r=Math.asin(this.getH()/(2*e)),n=o.svg.arc()({innerRadius:e,outerRadius:e,startAngle:-Math.PI/2-r,endAngle:-Math.PI/2+r}),i=o.svg.line()([[this.getW(),0],[0,0],[0,this.getH()],[this.getW(),this.getH()]]);t.append("svg:path").attr("d",i).attr("style","stroke:black;fill:white;"),t.append("svg:path").attr("d",n).attr("transform","translate("+(this.getW()+e*Math.cos(r))+","+this.getH()/2+")").attr("style","stroke:black;fill:white;")},getText:function(){return this.node.args.join(" ")}});var c=function(){l.prototype.constructor.apply(this,arguments)};n.extend(c.prototype,l.prototype,{renderBox:function(t){var e=.4*this.getH(),r=o.svg.arc()({innerRadius:e,outerRadius:e,startAngle:0,endAngle:Math.PI/2}),n=o.svg.line()([[this.getW()-e,0],[0,0],[0,this.getH()],[this.getW(),this.getH()],[this.getW(),e]]);t.append("svg:path").attr("d",n).attr("style","stroke:black;fill:white;"),t.append("svg:path").attr("d",r).attr("transform","translate("+(this.getW()-e)+","+e+")").attr("style","stroke:black;fill:white;")},getText:function(){return this.node.args.slice(0,1).join(" ")}});var p=function(){l.prototype.constructor.apply(this,arguments)};n.extend(p.prototype,l.prototype,{render:function(t){t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:white;"),t.append("circle").attr("cx",this.getW()/2).attr("cy",this.getH()/2).attr("r",this.getW()/2).attr("style","stroke:black;fill:white;"),this.renderOutlets(t),this.renderInlets(t)},getW:function(){return 20},getH:function(){return 20}});var h=function(){a.prototype.constructor.apply(this,arguments)};n.extend(h.prototype,a.prototype,{render:function(t){t.append("text").attr("class","comment").attr("style","font-size:10px;").text(this.node.args[0])}})}(r["svg-rendering"]={},e["svg-rendering"]={},n),function(t){t.parse=n("./lib/parsing").parse,t.renderSvg=n("./lib/svg-rendering").render}(t)})(window);