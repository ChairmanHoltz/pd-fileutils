/*
 * pd-fileutils - v0.0.2
 * Copyright (c) 2013 SÃ©bastien Piquemal <sebpiq@gmail.com> http://funktion.fm/
 *
 * BSD Simplified License.
 * For information on usage and redistribution, and for a DISCLAIMER OF ALL
 * WARRANTIES, see the file, "LICENSE.txt," in this distribution.
 *
 * See git@github.com:sebpiq/pd-fileutils.git for documentation
 *
 */
(function(){var t=this.pdfu={},e={underscore:this._},r={},n=function(t){return t=t.split("/").slice(-1)[0],r[t]&&r[t].exports||e[t]||window[t]};(function(t,e,r){var n=r("underscore"),o=t.exports=function(t){n.extend(this,t)};n.extend(o.prototype,{getNode:function(t){return n.find(this.nodes,function(e){return e.id===t})||null},guessPortlets:function(){var t=this;n.each(this.nodes,function(e){e.outlets=n.reduce(t.connections,function(t,r){return r.source.id===e.id?Math.max(t,r.source.port):t},-1)+1,e.inlets=n.reduce(t.connections,function(t,r){return r.sink.id===e.id?Math.max(t,r.sink.port):t},-1)+1})},getSinks:function(t){var e=n.filter(this.connections,function(e){return e.source.id===t.id}),r=n.uniq(n.map(e,function(t){return t.sink.id})),o=this;return n.map(r,function(t){return o.getNode(t)})},getSources:function(t){var e=n.filter(this.connections,function(e){return e.sink.id===t.id}),r=n.uniq(n.map(e,function(t){return t.source.id})),o=this;return n.map(r,function(t){return o.getNode(t)})}})})(r.Patch={},e.Patch={},n),function(t,e,r){var n=r("underscore"),o=["obj","floatatom","symbolatom","msg","text"],i=/ |\r\n?|\n/,s=/\\(\$\d+)/g,a=/(#((.|\r|\n)*?)[^\\\\])\r{0,1}\n{0,1};\r{0,1}(\n|$)/i,l=e.parseArg=function(t){var e=u(t);if(n.isNumber(e)&&!isNaN(e))return e;if(n.isString(t)){for(var r,t=t.substr(0);r=s.exec(t);)t=t.replace(r[0],r[1]);return t}throw Error("couldn't parse arg "+t)},u=e.parseFloat=function(t){return n.isNumber(t)&&!isNaN(t)?t:n.isString(t)?parseFloat(t):0/0},p=e.parseArgs=function(t){if(n.isNumber(t)&&!isNaN(t))return[t];var e,r,o,s=n.isString(t)?t.split(i):t,a=[];for(r=0,o=s.length;o>r;r++)""!==(e=s[r])&&a.push(l(e));return a};e.parse=function(t){return c(t)[0]};var c=function(t){var e,r=null,s=-1,l=function(){return s++,s},u={nodes:[],connections:[],layout:void 0,args:[]},h=!0,d=function(){t=t.slice(e.index+e[0].length)};for(a.lastIndex=0;e=t.match(a);){var f=e[1].split(i),y=f[0];if("#N"===y){var b=f[1];if("canvas"!==b)throw Error("invalid element type for chunk #N : "+b);if(h)u.layout={x:parseInt(f[2],10),y:parseInt(f[3],10),width:parseInt(f[4],10),height:parseInt(f[5],10),openOnLoad:f[7]},u.args=[f[6]],d();else{var x=c(t),v=x[0],m=x[2];u.nodes.push(n.extend({id:l(),subpatch:v},m)),t=x[1]}}else if("#X"===y){var b=f[1];if("restore"===b){var w={x:parseInt(f[2],10),y:parseInt(f[3],10)},k=f[4],W=[];if("pd"===k&&W.push(f[5]),r){for(var B=r.args[1];B>r.data.length;)r.data.push(0);r=null}return d(),[u,t,{proto:k,args:W,layout:w}]}if(n.contains(o,b)){var H,W,x,w={x:parseInt(f[2],10),y:parseInt(f[3],10)};"obj"===b?(H=f[4],W=f.slice(5)):(H=b,W=f.slice(4)),"text"===b&&(W=[f.slice(4).join(" ")]),x=g(H,W,w),W=x[0],w=x[1],u.nodes.push({id:l(),proto:H,layout:w,args:p(W)})}else if("array"===b){var z=f[2],I=parseFloat(f[3]),S={id:l(),proto:"table",args:[z,I],data:[]};u.nodes.push(S),r=S}else if("connect"===b){var C=parseInt(f[2],10),X=parseInt(f[4],10),N=parseInt(f[3],10),Y=parseInt(f[5],10);u.connections.push({source:{id:C,port:N},sink:{id:X,port:Y}})}else if("coords"!==b)throw Error("invalid element type for chunk #X : "+b);d()}else{if("#A"!==y)throw Error("invalid chunk : "+y);var F,R,O,T=parseFloat(f[1]);if(r)for(F=2,R=f.length;R>F;F++,T++)O=parseFloat(f[F]),n.isNumber(O)&&!isNaN(O)&&(r.data[T]=O);else console.error("got table data outside of a table.");d()}h=!1}return[u,""]},g=function(t,e,r){return"floatatom"===t?(r.width=e[0],r.labelPos=e[3],r.label=e[4],e=[e[1],e[2],e[5],e[6]]):"symbolatom"===t?(r.width=e[0],r.labelPos=e[3],r.label=e[4],e=[e[1],e[2],e[5],e[6]]):"bng"===t?(r.size=e[0],r.hold=e[1],r.interrupt=e[2],r.label=e[6],r.labelX=e[7],r.labelY=e[8],r.labelFont=e[9],r.labelFontSize=e[10],r.bgColor=e[11],r.fgColor=e[12],r.labelColor=e[13],e=[e[3],e[4],e[5]]):"tgl"===t?(r.size=e[0],r.label=e[4],r.labelX=e[5],r.labelY=e[6],r.labelFont=e[7],r.labelFontSize=e[8],r.bgColor=e[9],r.fgColor=e[10],r.labelColor=e[11],e=[e[1],e[2],e[3],e[12],e[13]]):"nbx"===t?(r.size=e[0],r.height=e[1],r.log=e[4],r.label=e[8],r.labelX=e[9],r.labelY=e[10],r.labelFont=e[11],r.labelFontSize=e[12],r.bgColor=e[13],r.fgColor=e[14],r.labelColor=e[15],r.logHeight=e[16],e=[e[2],e[3],e[5],e[6],e[7]]):"vsl"===t?(r.width=e[0],r.height=e[1],r.log=e[4],r.label=e[8],r.labelX=e[9],r.labelY=e[10],r.labelFont=e[11],r.labelFontSize=e[12],r.bgColor=e[13],r.fgColor=e[14],r.labelColor=e[15],r.steadyOnClick=e[17],e=[e[2],e[3],e[5],e[6],e[7],e[16]]):"hsl"===t?(r.width=e[0],r.height=e[1],r.log=e[4],r.label=e[8],r.labelX=e[9],r.labelY=e[10],r.labelFont=e[11],r.labelFontSize=e[12],r.bgColor=e[13],r.fgColor=e[14],r.labelColor=e[15],r.steadyOnClick=e[17],e=[e[2],e[3],e[5],e[6],e[7],e[16]]):"vradio"===t?(r.size=e[0],r.label=e[6],r.labelX=e[7],r.labelY=e[8],r.labelFont=e[9],r.labelFontSize=e[10],r.bgColor=e[11],r.fgColor=e[12],r.labelColor=e[13],e=[e[1],e[2],e[3],e[4],e[5],e[14]]):"hradio"===t?(r.size=e[0],r.label=e[6],r.labelX=e[7],r.labelY=e[8],r.labelFont=e[9],r.labelFontSize=e[10],r.bgColor=e[11],r.fgColor=e[12],r.labelColor=e[13],e=[e[1],e[2],e[3],e[4],e[5],e[14]]):"vu"===t?(r.width=e[0],r.height=e[1],r.label=e[3],r.labelX=e[4],r.labelY=e[5],r.labelFont=e[6],r.labelFontSize=e[7],r.bgColor=e[8],r.labelColor=e[9],r.log=e[10],e=[e[2],e[11]]):"cnv"===t&&(r.size=e[0],r.width=e[1],r.height=e[2],r.label=e[5],r.labelX=e[6],r.labelY=e[7],r.labelFont=e[8],r.labelFontSize=e[9],r.bgColor=e[10],r.labelColor=e[11],e=[e[3],e[4],e[12]]),[e,r]}}(r.parsing={},e.parsing={},n),function(t,e,r){var n=r("underscore"),o=r("d3"),i=r("./Patch"),s={portletWidth:5,portletHeight:3.5,objMinWidth:25,objMinHeight:15,ratio:1.2,svgFile:!0};e.render=function(t,e){e=e||{},n.defaults(e,s),o.select("svg").remove();var r,a,p=o.select("body").append("div"),k=p.append("svg").attr("style","font-family:monospace").attr("xmlns","http://www.w3.org/2000/svg").attr("version","1.1");t=new i(t),t.guessPortlets(),t.nodes=n.map(t.nodes,function(t){var r=t.proto;return"msg"===r?new u(t,e):"text"===r?new w(t,e):"floatatom"===r?new c(t,e):"symbolatom"===r?new g(t,e):"bng"===r?new h(t,e):"tgl"===r?new d(t,e):"nbx"===r?new f(t,e):"hsl"===r?new y(t,e):"vsl"===r?new b(t,e):"hradio"===r?new x(t,e):"vradio"===r?new v(t,e):"vu"===r?new m(t,e):new l(t,e)}),a=k.selectAll("g.node").data(t.nodes).enter().append("g").attr("transform",function(t){return"translate("+t.getX()+" "+t.getY()+")"}).attr("class","node").each(function(t){t.render(o.select(this))}),r=k.selectAll("line.connection").data(t.connections).enter().append("line").attr("class","connection").attr("style","stroke:black;stroke-width:2px;").each(function(r){var n=t.getNode(r.source.id),i=t.getNode(r.sink.id);o.select(this).attr("x1",function(t){return n.getOutletX(t.source.port)+e.portletWidth/2}).attr("y1",function(t){return n.getOutletY(t.source.port)+e.portletHeight}).attr("x2",function(t){return i.getInletX(t.sink.port)+e.portletWidth/2}).attr("y2",function(t){return i.getInletY(t.sink.port)})});var W=p[0][0].innerHTML;return e.svgFile?W='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+W:p.remove(),W};var a=function(t,e){this.opts=e,this.node=t,this.id=t.id};n.extend(a.prototype,{getX:function(){return this.node.layout.x*this.opts.ratio},getY:function(){return this.node.layout.y*this.opts.ratio},getOutletX:function(t){return this.getOutletRelX(t)+this.getX()},getInletX:function(t){return this.getInletRelX(t)+this.getX()},getOutletY:function(t){return this.getOutletRelY(t)+this.getY()},getInletY:function(t){return this.getInletRelY(t)+this.getY()},render:function(){throw Error("Implement me")},getOutletRelX:function(){throw Error("Implement me")},getInletRelX:function(){throw Error("Implement me")},getOutletRelY:function(){throw Error("Implement me")},getInletRelY:function(){throw Error("Implement me")}});var l=function(){a.prototype.constructor.apply(this,arguments)};n.extend(l.prototype,a.prototype,{render:function(t){this.renderBox(t),this.renderText(t),this.renderOutlets(t),this.renderInlets(t)},renderBox:function(t){t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:white;")},renderText:function(t){t.append("text").attr("class","proto").text(this.getText()).attr("dy",this.getTextY()).attr("dx",this.opts.portletWidth).attr("style","font-size:10px;")},renderInlets:function(t){this._genericRenderPortlets("inlet",t)},renderOutlets:function(t){this._genericRenderPortlets("outlet",t)},_genericRenderPortlets:function(t,e){var r=t.substr(0,1).toUpperCase()+t.substr(1),o=this;e.selectAll("rect."+t).data(n.range(this.node[t+"s"])).enter().append("rect").classed(t,!0).classed("portlet",!0).attr("width",this.opts.portletWidth).attr("height",this.opts.portletHeight).attr("x",function(t){return o["get"+r+"RelX"](t)}).attr("y",function(t){return o["get"+r+"RelY"](t)})},getH:function(){return this.opts.objMinHeight},getW:function(){var t=Math.max(this.node.inlets,this.node.outlets),e=6*this.getText().length+10;return Math.max((t-1)*this.opts.objMinWidth,this.opts.objMinWidth,e)},getText:function(){return this.node.proto+" "+this.node.args.join(" ")},getTextY:function(){return this.getH()/2+4.4},getOutletRelX:function(t){return this._genericPortletRelX("outlets",t)},getInletRelX:function(t){return this._genericPortletRelX("inlets",t)},getOutletRelY:function(){return this.getH()-this.opts.portletHeight},getInletRelY:function(){return 0},_genericPortletRelX:function(t,e){var r=this.getW(),n=this.node[t];if(0===e)return 0;if(e===n-1)return r-this.opts.portletWidth;var o=(r-n*this.opts.portletWidth)/(n-1);return e*(this.opts.portletWidth+o)}});var u=function(){l.prototype.constructor.apply(this,arguments)};n.extend(u.prototype,l.prototype,{renderBox:function(t){var e=.75*this.getH(),r=Math.asin(this.getH()/(2*e)),n=o.svg.arc()({innerRadius:e,outerRadius:e,startAngle:-Math.PI/2-r,endAngle:-Math.PI/2+r}),i=o.svg.line()([[this.getW(),0],[0,0],[0,this.getH()],[this.getW(),this.getH()]]);t.append("svg:path").attr("d",i).attr("style","stroke:black;fill:white;"),t.append("svg:path").attr("d",n).attr("transform","translate("+(this.getW()+e*Math.cos(r))+" "+this.getH()/2+")").attr("style","stroke:black;fill:white;")},getText:function(){return this.node.args.join(" ")}});var p=function(){l.prototype.constructor.apply(this,arguments)};n.extend(p.prototype,l.prototype,{renderBox:function(t){var e=.4*this.getH(),r=o.svg.arc()({innerRadius:e,outerRadius:e,startAngle:0,endAngle:Math.PI/2}),n=o.svg.line()([[this.getW()-e,0],[0,0],[0,this.getH()],[this.getW(),this.getH()],[this.getW(),e]]);t.append("svg:path").attr("d",n).attr("style","stroke:black;fill:white;"),t.append("svg:path").attr("d",r).attr("transform","translate("+(this.getW()-e)+" "+e+")").attr("style","stroke:black;fill:white;")}});var c=function(){p.prototype.constructor.apply(this,arguments)};n.extend(c.prototype,p.prototype,{getText:function(){return"0"}});var g=function(){p.prototype.constructor.apply(this,arguments)};n.extend(g.prototype,p.prototype,{getText:function(){return"symbol"}});var h=function(){l.prototype.constructor.apply(this,arguments)};n.extend(h.prototype,l.prototype,{render:function(t){t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:white;"),t.append("circle").attr("cx",this.getW()/2).attr("cy",this.getH()/2).attr("r",this.getW()/3).attr("style","stroke:black;fill:white;"),this.renderOutlets(t),this.renderInlets(t)},getW:function(){return 20},getH:function(){return 20}});var d=function(){l.prototype.constructor.apply(this,arguments)};n.extend(d.prototype,l.prototype,{render:function(t){var e=o.svg.symbol().size(this.getW()*this.getH()/3.5).type("cross")([1]);t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:white;"),t.append("svg:path").attr("d",e).attr("transform","rotate(45 "+this.getW()/2+" "+this.getH()/2+") translate("+this.getW()/2+" "+this.getH()/2+")").attr("style","stroke:black;fill:white;"),this.renderOutlets(t),this.renderInlets(t)},getW:function(){return 20},getH:function(){return 20}});var f=function(){p.prototype.constructor.apply(this,arguments)};n.extend(f.prototype,p.prototype,{renderBox:function(t){p.prototype.renderBox.apply(this,arguments);var e=o.svg.line()([[0,0],[this.getW()/6,this.getH()/2],[0,this.getH()]]);t.append("svg:path").attr("d",e).attr("style","stroke:black;fill:white;")},getText:function(){return"0"}});var y=function(){l.prototype.constructor.apply(this,arguments)};n.extend(y.prototype,l.prototype,{renderBox:function(t){l.prototype.renderBox.apply(this,arguments);var e=o.svg.line()([[5,0],[10,0],[10,this.getH()],[5,this.getH()],[5,0]]);t.append("svg:path").attr("d",e).attr("style","stroke:black;fill:black;")},getText:function(){return""},getW:function(){return 200},getH:function(){return 20}});var b=function(){l.prototype.constructor.apply(this,arguments)};n.extend(b.prototype,l.prototype,{renderBox:function(t){l.prototype.renderBox.apply(this,arguments);var e=o.svg.line()([[0,5],[0,10],[this.getW(),10],[this.getW(),5],[0,5]]);t.append("svg:path").attr("d",e).attr("style","stroke:black;fill:black;")},getText:function(){return""},getW:function(){return 20},getH:function(){return 200}});var x=function(){l.prototype.constructor.apply(this,arguments)};n.extend(x.prototype,l.prototype,{renderBox:function(t){var e,r=this.getNBoxes(),n=this.getBoxSize()/1.5;for(e=0;r>e;e++)t.append("rect").attr("width",this.getBoxSize()).attr("height",this.getBoxSize()).attr("transform","translate("+e*this.getBoxSize()+" "+0+")").attr("style","stroke:black;fill:white;");t.append("rect").attr("width",n).attr("height",n).attr("transform","translate("+(this.getBoxSize()-n)/2+" "+(this.getBoxSize()-n)/2+")").attr("style","stroke:black;fill:black;")},getW:function(){return this.getBoxSize()*this.getNBoxes()},getH:function(){return this.getBoxSize()},getBoxSize:function(){return 20},getNBoxes:function(){return this.node.args[2]},getText:function(){return""}});var v=function(){l.prototype.constructor.apply(this,arguments)};n.extend(v.prototype,l.prototype,{renderBox:function(t){var e,r=this.getNBoxes(),n=this.getBoxSize()/1.5;for(e=0;r>e;e++)t.append("rect").attr("width",this.getBoxSize()).attr("height",this.getBoxSize()).attr("transform","translate(0 "+e*this.getBoxSize()+")").attr("style","stroke:black;fill:white;");t.append("rect").attr("width",n).attr("height",n).attr("transform","translate("+(this.getBoxSize()-n)/2+" "+(this.getBoxSize()-n)/2+")").attr("style","stroke:black;fill:black;")},getW:function(){return this.getBoxSize()},getH:function(){return this.getBoxSize()*this.getNBoxes()},getBoxSize:function(){return 20},getNBoxes:function(){return this.node.args[2]},getText:function(){return""}});var m=function(){l.prototype.constructor.apply(this,arguments)};n.extend(m.prototype,l.prototype,{renderBox:function(t){t.append("rect").attr("class","box").attr("width",this.getW()).attr("height",this.getH()).attr("style","stroke:black;fill:grey;")},getText:function(){return""},getW:function(){return 20},getH:function(){return 200}});var w=function(){a.prototype.constructor.apply(this,arguments)};n.extend(w.prototype,a.prototype,{render:function(t){t.append("text").attr("class","comment").attr("style","font-size:10px;").text(this.node.args[0])}})}(r["svg-rendering"]={},e["svg-rendering"]={},n),function(t,e,r){var n=r("mustache"),o=r("underscore");e.render=function(t){var e="",r=o.clone(t.layout||{});return o.defaults(r,{x:0,y:0,width:500,height:500}),e+=n.render(i,{args:t.args,layout:r})+";\n",o.forEach(t.nodes.sort(function(t,e){return t.id-e.id}),function(t){var r=o.clone(t.layout||{});o.defaults(r,{x:0,y:0}),e+=n.render(a,{args:t.args,layout:r,proto:t.proto})+";\n"}),o.forEach(t.connections,function(t){e+=n.render(s,t)+";\n"}),e};var i="#N canvas {{{layout.x}}} {{{layout.y}}} {{{layout.width}}} {{{layout.height}}} {{{args.0}}}{{#layout.openOnLoad}} {{{.}}}{{/layout.openOnLoad}}",s="#X connect {{{source.id}}} {{{source.port}}} {{{sink.id}}} {{{sink.port}}}",a="#X obj {{{layout.x}}} {{{layout.y}}} {{{proto}}}{{#args}} {{.}}{{/args}}"}(r["pd-rendering"]={},e["pd-rendering"]={},n),function(t){t.parse=n("./lib/parsing").parse,t.renderSvg=n("./lib/svg-rendering").render,t.renderPd=n("./lib/pd-rendering").render}(t)})(window);